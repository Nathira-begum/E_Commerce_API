<!DOCTYPE html>
<html>
  <head>
    <title>OTP Login</title>
  </head>
  <body>
    <h2>Phone OTP Login</h2>
    <input type="text" id="phoneNumber" placeholder="+91xxxxxxxxxx" />
    <div id="recaptcha-container"></div>
    <button onclick="sendOTP()">Send OTP</button>

    <br /><br />

    <input type="text" id="otp" placeholder="Enter OTP" />
    <button onclick="verifyOTP()">Verify OTP</button>

    <!-- âœ… Use ONLY this module script block -->
    <script type="module">
      import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
      import {
        getAuth,
        RecaptchaVerifier,
        signInWithPhoneNumber,
      } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDbVbVgBZtXSEghTjcyP0wuMvVl8e9uJHY",
        authDomain: "trendify-modern-clothing-2e636.firebaseapp.com",
        projectId: "trendify-modern-clothing-2e636",
        storageBucket: "trendify-modern-clothing-2e636.appspot.com",
        messagingSenderId: "1036087618060",
        appId: "1:1036087618060:web:5079ee1f56c1b7cfc25c29",
      };

      const app = initializeApp(firebaseConfig);
      const auth = getAuth(app);

      window.recaptchaVerifier = new RecaptchaVerifier(
        auth,
        "recaptcha-container",
        {
          size: "invisible",
          callback: (response) => {
            console.log("reCAPTCHA verified");
          },
        }
      );

      let confirmationResult;

      window.sendOTP = () => {
        const phoneNumber = document.getElementById("phoneNumber").value;
        signInWithPhoneNumber(auth, phoneNumber, window.recaptchaVerifier)
          .then((result) => {
            confirmationResult = result;
            alert("OTP sent!");
          })
          .catch((error) => {
            console.error("Error sending OTP:", error);
          });
      };

      window.verifyOTP = () => {
        const code = document.getElementById("otp").value;
        confirmationResult
          .confirm(code)
          .then(async (result) => {
            const user = result.user;
            const idToken = await user.getIdToken();
            console.log("User token:=", idToken);

            const res = await fetch("http://localhost:5000/auth/verify-otp", {
              method: "POST",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ idToken }),
            });

            const data = await res.json();
            alert("Backend response: " + JSON.stringify(data));
          })
          .catch((error) => {
            console.error("OTP Verification Error:", error);
            alert("Invalid OTP");
          });
      };
    </script>
  </body>
</html>
